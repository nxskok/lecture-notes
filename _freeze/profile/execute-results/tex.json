{
  "hash": "4ec98ed8519bd59280922c384f375cd4",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Repeated measures analysis\"\neditor: \n  markdown: \n    wrap: 72\n---\n\n\n\n\n## Repeated measures by profile analysis\n\n-   More than one response *measurement* for each subject. Might be\n\n    -   measurements of the same thing at different times\n\n    -   measurements of different but related things\n\n-   Generalization of matched pairs (\"matched triples\", etc.).\n\n-   Variation: each subject does several different treatments at\n    different times (called *crossover design*).\n\n-   Expect measurements on same subject to be correlated, so assumptions\n    of independence will fail.\n\n-   Called *repeated measures*. Different approaches, but *profile\n    analysis* uses `Manova` (set up right way).\n\n-   Another approach uses *mixed models* (random effects).\n\n## Packages\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(car)\nlibrary(tidyverse)\nlibrary(lme4) # for mixed models later\n```\n:::\n\n\n\n\n## Example: histamine in dogs\n\n-   8 dogs take part in experiment.\n\n-   Dogs randomized to one of 2 different drugs.\n\n-   Response: log of blood concentration of histamine 0, 1, 3 and 5\n    minutes after taking drug. (Repeated measures.)\n\n-   Data in `dogs.txt`, column-aligned.\n\n## Read in data\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmy_url <- \"http://ritsokiguess.site/datafiles/dogs.txt\"\ndogs <- read_table(my_url)\ndogs\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8 x 7\n  dog   drug         x       lh0   lh1   lh3   lh5\n  <chr> <chr>        <chr> <dbl> <dbl> <dbl> <dbl>\n1 A     Morphine     N     -3.22 -1.61 -2.3  -2.53\n2 B     Morphine     N     -3.91 -2.81 -3.91 -3.91\n3 C     Morphine     N     -2.66  0.34 -0.73 -1.43\n4 D     Morphine     N     -1.77 -0.56 -1.05 -1.43\n5 E     Trimethaphan N     -3.51 -0.48 -1.17 -1.51\n6 F     Trimethaphan N     -3.51  0.05 -0.31 -0.51\n7 G     Trimethaphan N     -2.66 -0.19  0.07 -0.22\n8 H     Trimethaphan N     -2.41  1.14  0.72  0.21\n```\n\n\n:::\n:::\n\n\n\n\n## Setting things up\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse <- with(dogs, cbind(lh0, lh1, lh3, lh5))\nresponse\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       lh0   lh1   lh3   lh5\n[1,] -3.22 -1.61 -2.30 -2.53\n[2,] -3.91 -2.81 -3.91 -3.91\n[3,] -2.66  0.34 -0.73 -1.43\n[4,] -1.77 -0.56 -1.05 -1.43\n[5,] -3.51 -0.48 -1.17 -1.51\n[6,] -3.51  0.05 -0.31 -0.51\n[7,] -2.66 -0.19  0.07 -0.22\n[8,] -2.41  1.14  0.72  0.21\n```\n\n\n:::\n:::\n\n\n\n\n## Another way to make response\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs %>% select(starts_with(\"lh\")) %>% \n  as.matrix() -> response\nresponse\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       lh0   lh1   lh3   lh5\n[1,] -3.22 -1.61 -2.30 -2.53\n[2,] -3.91 -2.81 -3.91 -3.91\n[3,] -2.66  0.34 -0.73 -1.43\n[4,] -1.77 -0.56 -1.05 -1.43\n[5,] -3.51 -0.48 -1.17 -1.51\n[6,] -3.51  0.05 -0.31 -0.51\n[7,] -2.66 -0.19  0.07 -0.22\n[8,] -2.41  1.14  0.72  0.21\n```\n\n\n:::\n:::\n\n\n\n\n\n## The repeated measures MANOVA\n\nGet list of response variable names; we call them `times`. Save in data\nframe.\n\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\n\\small\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntimes <- colnames(response)\ntimes\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"lh0\" \"lh1\" \"lh3\" \"lh5\"\n```\n\n\n:::\n\n```{.r .cell-code}\ntimes.df <- data.frame(times=factor(times))\ntimes.df\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  times\n1   lh0\n2   lh1\n3   lh3\n4   lh5\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n## Fitting the model\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs.1 <- lm(response ~ drug, data = dogs)\ndogs.2 <- Manova(dogs.1,\n  idata = times.df,\n  idesign = ~times\n)\n```\n:::\n\n\n\n\n## The output (some; there is a lot)\n\n\\tiny\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dogs.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nType II Repeated Measures MANOVA Tests:\n\n------------------------------------------\n \nTerm: (Intercept) \n\n Response transformation matrix:\n    (Intercept)\nlh0           1\nlh1           1\nlh3           1\nlh5           1\n\nSum of squares and products for the hypothesis:\n            (Intercept)\n(Intercept)     285.366\n\nMultivariate Tests: (Intercept)\n                 Df test stat approx F num Df den Df    Pr(>F)   \nPillai            1  0.763467 19.36642      1      6 0.0045648 **\nWilks             1  0.236533 19.36642      1      6 0.0045648 **\nHotelling-Lawley  1  3.227738 19.36642      1      6 0.0045648 **\nRoy               1  3.227738 19.36642      1      6 0.0045648 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n------------------------------------------\n \nTerm: drug \n\n Response transformation matrix:\n    (Intercept)\nlh0           1\nlh1           1\nlh3           1\nlh5           1\n\nSum of squares and products for the hypothesis:\n            (Intercept)\n(Intercept)       46.08\n\nMultivariate Tests: drug\n                 Df test stat approx F num Df den Df  Pr(>F)\nPillai            1 0.3426263 3.127229      1      6 0.12741\nWilks             1 0.6573737 3.127229      1      6 0.12741\nHotelling-Lawley  1 0.5212048 3.127229      1      6 0.12741\nRoy               1 0.5212048 3.127229      1      6 0.12741\n\n------------------------------------------\n \nTerm: times \n\n Response transformation matrix:\n    times1 times2 times3\nlh0      1      0      0\nlh1      0      1      0\nlh3      0      0      1\nlh5     -1     -1     -1\n\nSum of squares and products for the hypothesis:\n         times1     times2     times3\ntimes1  18.9728 -11.103400 -4.0810000\ntimes2 -11.1034   6.498012  2.3883125\ntimes3  -4.0810   2.388313  0.8778125\n\nMultivariate Tests: times\n                 Df test stat approx F num Df den Df    Pr(>F)   \nPillai            1  0.949879 25.26898      3      4 0.0046308 **\nWilks             1  0.050121 25.26898      3      4 0.0046308 **\nHotelling-Lawley  1 18.951738 25.26898      3      4 0.0046308 **\nRoy               1 18.951738 25.26898      3      4 0.0046308 **\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n------------------------------------------\n \nTerm: drug:times \n\n Response transformation matrix:\n    times1 times2 times3\nlh0      1      0      0\nlh1      0      1      0\nlh3      0      0      1\nlh5     -1     -1     -1\n\nSum of squares and products for the hypothesis:\n         times1     times2     times3\ntimes1  7.60500  2.0572500 -0.0292500\ntimes2  2.05725  0.5565125 -0.0079125\ntimes3 -0.02925 -0.0079125  0.0001125\n\nMultivariate Tests: drug:times\n                 Df test stat approx F num Df den Df   Pr(>F)  \nPillai            1  0.894761 11.33619      3      4 0.020023 *\nWilks             1  0.105239 11.33619      3      4 0.020023 *\nHotelling-Lawley  1  8.502141 11.33619      3      4 0.020023 *\nRoy               1  8.502141 11.33619      3      4 0.020023 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\nUnivariate Type II Repeated-Measures ANOVA Assuming Sphericity\n\n            Sum Sq num Df Error SS den Df F value    Pr(>F)    \n(Intercept) 71.342      1  22.1026      6 19.3664  0.004565 ** \ndrug        11.520      1  22.1026      6  3.1272  0.127406    \ntimes       26.160      3   2.2534     18 69.6546 4.215e-10 ***\ndrug:times   5.111      3   2.2534     18 13.6095 7.050e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n\nMauchly Tests for Sphericity\n\n           Test statistic  p-value\ntimes             0.12334 0.084567\ndrug:times        0.12334 0.084567\n\n\nGreenhouse-Geisser and Huynh-Feldt Corrections\n for Departure from Sphericity\n\n            GG eps Pr(>F[GG])    \ntimes      0.52618  3.745e-06 ***\ndrug:times 0.52618   0.002349 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n              HF eps   Pr(>F[HF])\ntimes      0.6822614 1.843418e-07\ndrug:times 0.6822614 7.307096e-04\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n## What there is here\n\n-   three sets of tests, for\n\n    -   times; drug; their interaction\n\n-   two *types* of test for each of these:\n\n    -   univariate; multivariate\n\n-   univariate is more powerful *if* it applies; if it doesn't, can make adjustments to it\n\n## Sphericity\n\n-   The thing that decides whether the univariate tests apply is called\n    \"sphericity\".\n-   This holds if the outcomes have equal variance (to each other) and\n    have the same (positive) correlation across subjects.\n-   Tested using Mauchly's test (part of output)\n-   If sphericity rejected, there are adjustments to the univariate\n    P-values due to Huynh-Feldt and Greenhouse-Geisser. Huynh-Feldt\n    better if responses not actually normal (safer).\n\n## Univariate tests\n\n\\scriptsize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dogs.2)$sphericity.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           Test statistic  p-value\ntimes             0.12334 0.084567\ndrug:times        0.12334 0.084567\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(dogs.2)$pval.adjustments\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n              GG eps   Pr(>F[GG])    HF eps   Pr(>F[HF])\ntimes      0.5261798 3.744618e-06 0.6822614 1.843418e-07\ndrug:times 0.5261798 2.348896e-03 0.6822614 7.307096e-04\nattr(,\"na.action\")\n(Intercept)        drug \n          1           2 \nattr(,\"class\")\n[1] \"omit\"\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(dogs.2)$univariate.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            Sum Sq num Df Error SS den Df F value    Pr(>F)    \n(Intercept) 71.342      1  22.1026      6 19.3664  0.004565 ** \ndrug        11.520      1  22.1026      6  3.1272  0.127406    \ntimes       26.160      3   2.2534     18 69.6546 4.215e-10 ***\ndrug:times   5.111      3   2.2534     18 13.6095 7.050e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n## Comments\n\n-   The sphericity test for the interaction is almost significant\n-   The H-F adjusted P-value for the interaction is a bit bigger than\n    the univariate one, but still strongly significant.\n-   Therefore any lack of sphericity does not affect our conclusion:\n    there is an interaction between drug and time\n-   ie that the effect of time on log-histamine is different for the two\n    drugs.\n\n## Comments\n\n-   Here, univariate test with Huynh-Feldt correction to P-value for\n    interaction was 0.00073.\n-   Significant interaction *is* the conclusion here.\n-   If the interaction had not been significant:\n    -   cannot remove interaction with time\n    -   so look at univariate (better, especially if adjusted for\n        sphericity) tests of main effects in *this* model\n\n## Next\n\n-   Interaction significant. Pattern of response over time different for\n    the two drugs.\n\n-   Want to investigate interaction.\n\n## The wrong shape\n\n-   But data frame has several observations per line (\"wide format\"):\n\n\\scriptsize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs %>% slice(1:6)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 7\n  dog   drug         x       lh0   lh1   lh3   lh5\n  <chr> <chr>        <chr> <dbl> <dbl> <dbl> <dbl>\n1 A     Morphine     N     -3.22 -1.61 -2.3  -2.53\n2 B     Morphine     N     -3.91 -2.81 -3.91 -3.91\n3 C     Morphine     N     -2.66  0.34 -0.73 -1.43\n4 D     Morphine     N     -1.77 -0.56 -1.05 -1.43\n5 E     Trimethaphan N     -3.51 -0.48 -1.17 -1.51\n6 F     Trimethaphan N     -3.51  0.05 -0.31 -0.51\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n-   Plotting works with data in \"long format\": one response per line.\n\n-   The responses are log-histamine at different times, labelled\n    `lh`-something. Call them all `lh` and put them in one column, with\n    the time they belong to labelled.\n\n## Running `pivot_longer`, try 1\n\n\\footnotesize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs %>% pivot_longer(starts_with(\"lh\"), \n                      names_to = \"time\", values_to = \"lh\") \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 32 x 5\n   dog   drug     x     time     lh\n   <chr> <chr>    <chr> <chr> <dbl>\n 1 A     Morphine N     lh0   -3.22\n 2 A     Morphine N     lh1   -1.61\n 3 A     Morphine N     lh3   -2.3 \n 4 A     Morphine N     lh5   -2.53\n 5 B     Morphine N     lh0   -3.91\n 6 B     Morphine N     lh1   -2.81\n 7 B     Morphine N     lh3   -3.91\n 8 B     Morphine N     lh5   -3.91\n 9 C     Morphine N     lh0   -2.66\n10 C     Morphine N     lh1    0.34\n# i 22 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n## Getting the times\n\nNot quite right: for the times, we want just the numbers, not the\nletters `lh` every time. Want new variable containing just number in\n`time`: `parse_number`.\n\n\\footnotesize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs %>%\n  pivot_longer(starts_with(\"lh\"), \n               names_to = \"timex\", values_to = \"lh\") %>% \n  mutate(time = parse_number(timex)) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 32 x 6\n   dog   drug     x     timex    lh  time\n   <chr> <chr>    <chr> <chr> <dbl> <dbl>\n 1 A     Morphine N     lh0   -3.22     0\n 2 A     Morphine N     lh1   -1.61     1\n 3 A     Morphine N     lh3   -2.3      3\n 4 A     Morphine N     lh5   -2.53     5\n 5 B     Morphine N     lh0   -3.91     0\n 6 B     Morphine N     lh1   -2.81     1\n 7 B     Morphine N     lh3   -3.91     3\n 8 B     Morphine N     lh5   -3.91     5\n 9 C     Morphine N     lh0   -2.66     0\n10 C     Morphine N     lh1    0.34     1\n# i 22 more rows\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n## What I did differently\n\n-   I realized that `pivot_longer` was going to produce something like\n    `lh1`, which I needed to do something further with, so this time I\n    gave it a temporary name `timex` (which we actually *do* use later).\n\n-   This enabled me to use the name `time` for the actual numeric time.\n\n-   This works now, so next save into a new data frame `dogs.long`.\n\n## Saving the pipelined results\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs %>%\n  pivot_longer(starts_with(\"lh\"), \n               names_to = \"timex\", values_to = \"lh\") %>% \n  mutate(time = parse_number(timex)) -> dogs.long\ndogs.long\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 32 x 6\n   dog   drug     x     timex    lh  time\n   <chr> <chr>    <chr> <chr> <dbl> <dbl>\n 1 A     Morphine N     lh0   -3.22     0\n 2 A     Morphine N     lh1   -1.61     1\n 3 A     Morphine N     lh3   -2.3      3\n 4 A     Morphine N     lh5   -2.53     5\n 5 B     Morphine N     lh0   -3.91     0\n 6 B     Morphine N     lh1   -2.81     1\n 7 B     Morphine N     lh3   -3.91     3\n 8 B     Morphine N     lh5   -3.91     5\n 9 C     Morphine N     lh0   -2.66     0\n10 C     Morphine N     lh1    0.34     1\n# i 22 more rows\n```\n\n\n:::\n:::\n\n\n\n\n## Comments\n\nThis says:\n\n-   Take data frame dogs, and then:\n\n-   Combine the columns `lh0` through `lh5` into one column called `lh`,\n    with the column that each `lh` value originally came from labelled\n    by `timex`, and then:\n\n-   Pull out numeric values in `timex`, saving in `time` and then:\n\n-   save the result in a data frame `dogs.long`.\n\n## Interaction plot\n\n\\small\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(dogs.long, aes(x = time, y = lh, \n                      colour = drug, group = drug)) +\n  stat_summary(fun = mean, geom = \"point\") +\n  stat_summary(fun = mean, geom = \"line\")\n```\n\n::: {.cell-output-display}\n![](profile_files/figure-beamer/bProfile-10-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\\normalsize\n\n## Comments\n\n-   Plot mean `lh` value at each time, joining points on same drug by\n    lines.\n\n-   drugs same at time 0\n\n-   after that, Trimethaphan higher than Morphine.\n\n-   Effect of drug not consistent over time: significant interaction.\n\n## Take out time zero\n\n-   Lines on interaction plot would then be parallel, and so interaction\n    should no longer be significant.\n\n-   Go back to original \"wide\" `dogs` data frame.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse <- with(dogs, cbind(lh1, lh3, lh5)) # excl time 0\ndogs.1 <- lm(response ~ drug, data = dogs)\ntimes <- colnames(response)\ntimes.df <- data.frame(times=factor(times))\ndogs.2 <- Manova(dogs.1,\n  idata = times.df,\n  idesign = ~times\n)\n```\n:::\n\n\n\n\n## Results (univariate)\n\n\\scriptsize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dogs.2)$sphericity.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           Test statistic p-value\ntimes             0.57597 0.25176\ndrug:times        0.57597 0.25176\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(dogs.2)$pval.adjustments\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n              GG eps   Pr(>F[GG])    HF eps   Pr(>F[HF])\ntimes      0.7022305 0.0003752847 0.8520467 0.0001117394\ndrug:times 0.7022305 0.1078608639 0.8520467 0.0942573437\nattr(,\"na.action\")\n(Intercept)        drug \n          1           2 \nattr(,\"class\")\n[1] \"omit\"\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(dogs.2)$univariate.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n             Sum Sq num Df Error SS den Df F value    Pr(>F)    \n(Intercept) 24.2607      1  20.1874      6  7.2106   0.03628 *  \ndrug        16.2197      1  20.1874      6  4.8207   0.07053 .  \ntimes        3.3250      2   0.7301     12 27.3251 3.406e-05 ***\ndrug:times   0.3764      2   0.7301     12  3.0929   0.08254 .  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n## Comments\n\n-   sphericity: no problem (P-value 0.25)\n-   univariate test for interaction no longer significant (P-value\n    0.082)\n-   look at main effects:\n    -   strong significance of time, even after taking out time 0\n    -   actually *not* significant drug effect, despite interaction plot\n\n## Is the non-significant drug effect reasonable?\n\n-   Plot *actual data*: `lh` against `days`, labelling observations by\n    drug: \"spaghetti plot\".\n\n-   Uses long data frame (confusing, yes I know):\n\n-   Plot (time,lh) points coloured by drug\n\n-   and connecting measurements for each *dog* by lines.\n\n-   This time, we want `group = dog` (want the measurements for each\n    *dog* joined by lines), but `colour = drug`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(dogs.long, aes(x = time, y = lh,\n  colour = drug, group = dog)) +\n  geom_point() + geom_line() -> g\n```\n:::\n\n\n\n\n## The spaghetti plot\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng\n```\n\n::: {.cell-output-display}\n![](profile_files/figure-beamer/hoverla-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n## Comments\n\n-   For each dog over time, there is a strong increase and gradual\n    decrease in log-histamine. The gradual decrease explains the\n    significant time effect after we took out time 0.\n\n-   The pattern is more or less the same for each dog, regardless of\n    drug. This explains the non-significant interaction.\n\n-   Most of the trimethaphan dogs (blue) have higher log-histamine\n    throughout (time 1 and after), and some of the morphine dogs have\n    lower.\n\n-   *But* two of the morphine dogs have log-histamine profiles like the\n    trimethaphan dogs. This ambiguity is probably why the `drug` effect\n    is not quite significant.\n\n## Mixed models\n\n-   Another way to fit repeated measures\n-   Subjects (on whom repeated measures taken) are *random sample of all\n    possible subjects* (random effects)\n-   Times and treatments are *the only ones we care about* (fixed\n    effects)\n-   Use package `lme4` function `lmer` (like `lm` in some ways)\n-   Uses long-format \"tidy\" data\n\n## Fitting the model (uses `lme4`)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# dogs.long including time zero with categorical timex\nlibrary(lme4)\ndogs.3 <- lmer(lh ~ drug * timex + (1|dog), data=dogs.long)\n```\n:::\n\n\n\n\n-   note specification of random effect: each dog has \"random intercept\"\n    that moves log-histamine up or down for that dog over all times\n\n## What can we drop?\n\n-   using `drop1`:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndrop1(dogs.3,test=\"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nlh ~ drug * timex + (1 | dog)\n           npar    AIC    LRT   Pr(Chi)    \n<none>          62.167                     \ndrug:timex    3 84.589 28.422 2.962e-06 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n-   Interaction is very significant. Including time zero, the pattern of log-histamine over time is different for the two drugs (as we found before).\n\n## Omitting time zero\n\nLet's pretend we are working at $\\alpha = 0.01$:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs.long %>% filter(timex != \"lh0\") -> dogs.long.no0\ndogs.4 <- lmer(lh ~ drug * timex + (1|dog), data=dogs.long.no0)\ndrop1(dogs.4, test = \"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nlh ~ drug * timex + (1 | dog)\n           npar    AIC    LRT Pr(Chi)  \n<none>          42.119                 \ndrug:timex    2 44.771 6.6518 0.03594 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\nInteraction is not quite significant at $\\alpha = 0.01$. So we could remove it.\n\n## Removing the interaction\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndogs.5 <- update(dogs.4, . ~ . - drug:timex)\ndrop1(dogs.5, test = \"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nSingle term deletions\n\nModel:\nlh ~ drug + timex + (1 | dog)\n       npar    AIC     LRT  Pr(Chi)    \n<none>      44.771                     \ndrug      1 47.489  4.7176  0.02985 *  \ntimex     2 62.972 22.2011 1.51e-05 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\nThere is definitely an effect of time, but drug is not quite significant (at $\\alpha = 0.01$).\n\n## The exercise data\n\n-   30 people took part in an exercise study.\n\n-   Each subject was randomly assigned to one of two diets (\"low fat\" or\n    \"non-low fat\") and to one of three exercise programs (\"at rest\",\n    \"walking\", \"running\").\n\n-   There are $2\\times3 = 6$ experimental treatments, and thus each one\n    is replicated $30/6=5$ times.\n\n-   Nothing unusual so far.\n\n-   However, each subject had their pulse rate measured at three\n    different times (1, 15 and 30 minutes after starting their\n    exercise), so have repeated measures.\n\n## Reading the data\n\nSeparated by *tabs*:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"http://ritsokiguess.site/datafiles/exercise2.txt\"\nexercise.long <- read_tsv(url)\nexercise.long\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 90 x 5\n      id diet      exertype pulse time \n   <dbl> <chr>     <chr>    <dbl> <chr>\n 1     1 nonlowfat atrest      85 min01\n 2     1 nonlowfat atrest      85 min15\n 3     1 nonlowfat atrest      88 min30\n 4     2 nonlowfat atrest      90 min01\n 5     2 nonlowfat atrest      92 min15\n 6     2 nonlowfat atrest      93 min30\n 7     3 nonlowfat atrest      97 min01\n 8     3 nonlowfat atrest      97 min15\n 9     3 nonlowfat atrest      94 min30\n10     4 nonlowfat atrest      80 min01\n# i 80 more rows\n```\n\n\n:::\n:::\n\n\n\n\n-   This is \"long format\", which is usually what we want.\n\n-   But for repeated measures analysis, we want *wide* format!\n\n-   `pivot_wider`.\n\n## Making wide format\n\n-   `pivot_wider` needs: a column that is going to be split, and the\n    column to make the values out of:\n\n\\footnotesize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexercise.long %>% pivot_wider(names_from=time, \n                              values_from=pulse) -> exercise.wide\nexercise.wide %>% sample_n(5)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 5 x 6\n     id diet      exertype min01 min15 min30\n  <dbl> <chr>     <chr>    <dbl> <dbl> <dbl>\n1    14 nonlowfat walking     95    96   100\n2    24 nonlowfat running     87   132   120\n3    16 lowfat    walking     84    86    89\n4    26 lowfat    running     95   126   143\n5     9 lowfat    atrest      97    99    96\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n-   Normally `pivot_longer` \\texttt{min01, min15,\n    min30} into one column called `pulse` labelled by the number of\n    minutes. But `Manova` needs it the other way.\n\n## Setting up the repeated-measures analysis\n\n-   Make a response variable consisting of `min01, min15, min30`:\n\n\\small\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse <- with(exercise.wide, cbind(min01, min15, min30))\n```\n:::\n\n\n\n\n\\normalsize\n\n-   Predict that from `diet` and `exertype` and interaction using `lm`:\n\n\\small\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexercise.1 <- lm(response ~ diet * exertype,\n  data = exercise.wide\n)\n```\n:::\n\n\n\n\n\\normalsize\n\n-   Run this through `Manova`:\n\n\\small\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntimes <- colnames(response)\ntimes.df <- data.frame(times=factor(times))\nexercise.2 <- Manova(exercise.1, \n                     idata = times.df, \n                     idesign = ~times)\n```\n:::\n\n\n\n\n\\normalsize\n\n## Sphericity tests\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(exercise.2)$sphericity.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                    Test statistic p-value\ntimes                      0.92416 0.40372\ndiet:times                 0.92416 0.40372\nexertype:times             0.92416 0.40372\ndiet:exertype:times        0.92416 0.40372\n```\n\n\n:::\n:::\n\n\n\n\nNo problem with sphericity; go to univariate tests.\n\n## Univariate tests\n\n\n\n\n\n\n\n\n\n\\scriptsize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(exercise.2)$univariate.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                    Sum Sq num Df Error SS den Df    F value    Pr(>F)    \n(Intercept)         894608      1   2085.2     24 10296.6595 < 2.2e-16 ***\ndiet                  1262      1   2085.2     24    14.5238 0.0008483 ***\nexertype              8326      2   2085.2     24    47.9152 4.166e-09 ***\ndiet:exertype          816      2   2085.2     24     4.6945 0.0190230 *  \ntimes                 2067      2   1563.6     48    31.7206 1.662e-09 ***\ndiet:times             193      2   1563.6     48     2.9597 0.0613651 .  \nexertype:times        2723      4   1563.6     48    20.9005 4.992e-10 ***\ndiet:exertype:times    614      4   1563.6     48     4.7095 0.0027501 ** \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n\n\n\n\n\n\n\n\n-   The three-way interaction is significant\n    -   the effect of diet on pulse rate over time is different for the\n        different exercise types\n\n## Making some graphs\n\n-   Three-way interactions are difficult to understand. To make an\n    attempt, look at some graphs.\n\n-   Plot time trace of pulse rates for each individual, joined by lines,\n    and make *separate* plots for each `diet-exertype` combo.\n\n-   `ggplot` again. Using *long* data frame:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng <- ggplot(exercise.long, aes(\n  x = time, y = pulse,\n  group = id\n)) + geom_point() + geom_line() +\n  facet_grid(diet ~ exertype)\n```\n:::\n\n\n\n\n-   `facet_grid(diet~exertype)`: do a separate plot for each combination\n    of diet and exercise type, with diets going down the page and\n    exercise types going across. (Graphs are usually landscape, so have\n    the factor `exertype` with more levels going across.)\n\n## The graph(s)\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng\n```\n\n::: {.cell-output-display}\n![](profile_files/figure-beamer/bProfile-25-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n## Comments on graphs\n\n-   For subjects who were at rest, no change in pulse rate over time,\n    for both diet groups.\n\n-   For walking subjects, not much change in pulse rates over time.\n    Maybe a small increase on average between 1 and 15 minutes.\n\n-   For both running groups, an overall increase in pulse rate over\n    time, but the increase is stronger for the `lowfat` group.\n\n-   No consistent effect of diet over all exercise groups.\n\n-   No consistent effect of exercise type over both diet groups.\n\n-   No consistent effect of time over all diet-exercise type combos.\n\n## \"Simple effects\" of diet for the subjects who ran\n\n-   Looks as if there is only any substantial time effect for the\n    runners. For them, does diet have an effect?\n\n-   Pull out only the runners from the wide data:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nexercise.wide %>%\n  filter(exertype == \"running\") -> runners.wide\n```\n:::\n\n\n\n\n-   Create response variable and do MANOVA. Some of this looks like\n    before, but I have different data now:\n\n\\footnotesize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nresponse <- with(runners.wide, cbind(min01, min15, min30))\nrunners.1 <- lm(response ~ diet, data = runners.wide)\ntimes <- colnames(response)\ntimes.df <- data.frame(times=factor(times))\nrunners.2 <- Manova(runners.1,\n  idata = times.df,\n  idesign = ~times\n)\n```\n:::\n\n\n\n\n\\normalsize\n\n## Sphericity tests\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(runners.2)$sphericity.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n           Test statistic p-value\ntimes             0.81647  0.4918\ndiet:times        0.81647  0.4918\n```\n\n\n:::\n:::\n\n\n\n\n-   No problem, look at univariate tests.\n\n## Univariate tests\n\n\\footnotesize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(runners.2)$univariate.tests\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n            Sum Sq num Df Error SS den Df   F value    Pr(>F)    \n(Intercept) 383522      1    339.2      8 9045.3333 1.668e-13 ***\ndiet          1920      1    339.2      8   45.2830 0.0001482 ***\ntimes         4714      2   1242.0     16   30.3644 3.575e-06 ***\ndiet:times     789      2   1242.0     16    5.0795 0.0195874 *  \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n-   Interaction still significant\n    -   dependence of pulse rate on time still different for the two\n        diets\n\n## How is the effect of diet different over time?\n\n-   Table of means. Only I need long data for this:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrunners.wide %>%\n  pivot_longer(starts_with(\"min\"), \n               names_to = \"time\", values_to = \"pulse\") %>%\n  group_by(time, diet) %>%\n  summarize(\n    mean = mean(pulse),\n    sd = sd(pulse)\n  ) -> summ\n```\n:::\n\n\n\n\n-   Result of `summarize` is data frame, so can save it (and do more\n    with it if needed).\n\n## Understanding diet-time interaction\n\n-   The summary:\n\n\\footnotesize\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsumm\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 4\n# Groups:   time [3]\n  time  diet       mean    sd\n  <chr> <chr>     <dbl> <dbl>\n1 min01 lowfat     98.2  3.70\n2 min01 nonlowfat  94    4.53\n3 min15 lowfat    124.   8.62\n4 min15 nonlowfat 110.  13.1 \n5 min30 lowfat    141.   7.20\n6 min30 nonlowfat 111.   7.92\n```\n\n\n:::\n:::\n\n\n\n\n\\normalsize\n\n-   Pulse rates at any given time higher for `lowfat` (diet effect),\n\n-   Pulse rates increase over time of exercise (time effect),\n\n-   but the *amount by which pulse rate higher* for a diet depends on\n    time: `diet` by `time` interaction.\n\n## Interaction plot\n\n-   We went to trouble of finding means by group, so making interaction\n    plot is now mainly easy:\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(summ, aes(x = time, y = mean, colour = diet,\n                 group = diet)) + geom_point() + geom_line()\n```\n\n::: {.cell-output-display}\n![](profile_files/figure-beamer/bProfile-31-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n## Comment on interaction plot\n\n-   The lines are not parallel, so there is interaction between diet and\n    time for the runners.\n-   The effect of time on pulse rate is different for the two diets,\n    even though all the subjects here were running.\n",
    "supporting": [
      "profile_files/figure-beamer"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}