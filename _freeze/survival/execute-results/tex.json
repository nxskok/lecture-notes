{
  "hash": "982e1405ebff20ed31933584d1714eb7",
  "result": {
    "engine": "knitr",
    "markdown": " ---\ntitle: \"Survival Analysis\"\neditor: \n  markdown: \n    wrap: 72\n\n---\n\n## Survival analysis\n\n-   So far, have seen:\n\n    -   response variable counted or measured (regression)\n\n    -   response variable categorized (logistic regression)\n\n-   But what if response is time until event (eg. time of survival after\n    surgery)?\n\n-   Additional complication: event might not have happened at end of\n    study (eg. patient still alive). But knowing that patient has \"not\n    died yet\" presumably informative. Such data called *censored*.\n    \n    \n## ... continued \n\n-   Enter *survival analysis*, in particular the \"Cox proportional\n    hazards model\".\n\n-   Explanatory variables in this context often called *covariates*.\n\n## Packages\n\n-   Install package `survival` if not done. Also use `broom` and\n    `marginaleffects` from earlier.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(survival)\nlibrary(broom)\nlibrary(marginaleffects)\n```\n:::\n\n\n\n## Example: still dancing?\n\n-   12 women who have just started taking dancing lessons are followed\n    for up to a year, to see whether they are still taking dancing\n    lessons, or have quit. The \"event\" here is \"quit\".\n\n-   This might depend on:\n\n    -   a treatment (visit to a dance competition)\n\n    -   woman's age (at start of study).\n\n## Data\n\n\\normalsize\n\n```         \nMonths  Quit   Treatment Age\n1        1        0      16\n2        1        0      24\n2        1        0      18\n3        0        0      27\n4        1        0      25\n7        1        1      26\n8        1        1      36\n10       1        1      38\n10       0        1      45\n12       1        1      47\n```\n\n\\normalsize\n\n## About the data\n\n-   `months` and `quit` are kind of combined response:\n\n    -   `Months` is number of months a woman was actually observed\n        dancing\n\n    -   `quit` is 1 if woman quit, 0 if still dancing at end of study.\n\n-   Treatment is 1 if woman went to dance competition, 0 otherwise.\n\n-   Fit model and see whether `Age` or `Treatment` have effect on\n    survival.\n\n-   Want to do predictions for probabilities of still dancing as they\n    depend on whatever is significant, and draw plot.\n\n## Read data\n\n-   Column-aligned:\n\n\\normalsize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nurl <- \"http://ritsokiguess.site/datafiles/dancing.txt\"\ndance <- read_table(url)\n```\n:::\n\n\n\n\\normalsize\n\n## The data\n\n\\small\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 12 x 4\n   Months  Quit Treatment   Age\n    <dbl> <dbl>     <dbl> <dbl>\n 1      1     1         0    16\n 2      2     1         0    24\n 3      2     1         0    18\n 4      3     0         0    27\n 5      4     1         0    25\n 6      5     1         0    21\n 7     11     1         0    55\n 8      7     1         1    26\n 9      8     1         1    36\n10     10     1         1    38\n11     10     0         1    45\n12     12     1         1    47\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Fit model\n\n-   Response variable has to incorporate both the survival time\n    (`Months`) and whether or not the event, quitting, happened (that\n    is, if `Quit` is 1).\n-   This is made using `Surv` from `survival` package, with two inputs:\n    -   the column that has the survival times\n    -   something that is `TRUE` or 1 if the event happened.\n-   Easiest for us to create this when we fit the model, predicting\n    response from explanatories:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance.1 <- coxph(Surv(Months, Quit) ~ Treatment + Age, \n                 data = dance)\n```\n:::\n\n\n\n## What does `Surv` output actually look like?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance %>% mutate(y = Surv(Months, Quit)) %>% \n  slice(1:6) # top 6 rows to fit\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 6 x 5\n  Months  Quit Treatment   Age      y\n   <dbl> <dbl>     <dbl> <dbl> <Surv>\n1      1     1         0    16     1 \n2      2     1         0    24     2 \n3      2     1         0    18     2 \n4      3     0         0    27     3+\n5      4     1         0    25     4 \n6      5     1         0    21     5 \n```\n\n\n:::\n:::\n\n\n\n\n## Output looks a lot like regression\n\n\\scriptsize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dance.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(Months, Quit) ~ Treatment + Age, data = dance)\n\n  n= 12, number of events= 10 \n\n              coef exp(coef) se(coef)      z Pr(>|z|)  \nTreatment -4.44915   0.01169  2.60929 -1.705   0.0882 .\nAge       -0.36619   0.69337  0.15381 -2.381   0.0173 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n          exp(coef) exp(-coef) lower .95 upper .95\nTreatment   0.01169     85.554 7.026e-05    1.9444\nAge         0.69337      1.442 5.129e-01    0.9373\n\nConcordance= 0.964  (se = 0.039 )\nLikelihood ratio test= 21.68  on 2 df,   p=2e-05\nWald test            = 5.67  on 2 df,   p=0.06\nScore (logrank) test = 14.75  on 2 df,   p=6e-04\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Conclusions\n\n-   Use $\\alpha=0.10$ here since not much data.\n\n-   Three tests at bottom like global F-test. Consensus that something\n    predicts survival time (whether or not dancer quit and/or how long\n    it took).\n\n-   `Age` (definitely), `Treatment` (marginally) both predict survival\n    time.\n\n## Behind the scenes\n\n-   All depends on *hazard rate*, which is based on probability that\n    event happens in the next short time period, given that event has\n    not happened yet:\n\n-   $X$ denotes time to event, $\\delta$ is small time interval:\n\n-   $h(t) = P(X \\le t + \\delta | X \\ge t) / \\delta$\n\n-   if $h(t)$ large, event likely to happen soon (lifetime short)\n\n-   if $h(t)$ small, event unlikely to happen soon (lifetime long).\n\n## Modelling lifetime\n\n-   want to model hazard rate\n\n-   but hazard rate always positive, so actually model *log* of hazard\n    rate\n\n-   modelling how (log-)hazard rate depends on other things eg $X_1 =$\n    age, $X_2 =$ treatment, with the $\\beta$ being regression\n    coefficients:\n\n-   Cox model $h(t)=h_0(t)\\exp(\\beta_0+\\beta_1X_1+\\beta_2 X_2+\\cdots)$,\n    or:\n\n-   $\\log(h(t)) = \\log(h_0(t)) + \\beta_0 + \\beta_1 X_1 + \\beta_2 X_2 + \\cdots$\n\n-   like a generalized linear model with log link.\n\n## Predictions with `marginaleffects`\n\n-   Predicted survival probabilities depend on:\n    -   the combination of explanatory variables you are looking at\n    -   the time at which you are looking at them (when more time has\n        passed, it is more likely that the event has happened, so the\n        \"survival probability\" should be lower).\n-   look at effect of age by comparing ages 20 and 40, and later look at\n    the effect of treatment (values 1 and 0).\n-   Also have to provide some times to predict for, in `Months`.\n\n## Effect of age\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew <- datagrid(model = dance.1, Age = c(20, 40), Months = c(3, 5, 7))\nnew\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Quit Treatment Age Months rowid\n1    1         0  20      3     1\n2    1         0  20      5     2\n3    1         0  20      7     3\n4    1         0  40      3     4\n5    1         0  40      5     5\n6    1         0  40      7     6\n```\n\n\n:::\n:::\n\n\n\nThese are actually for women who *did not* go to the dance competition.\n\n## The predictions\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbind(predictions(dance.1, newdata = new, type = \"survival\")) %>% \n  select(Age, Treatment, Months, estimate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Age Treatment Months      estimate\n1  20         0      3  3.987336e-01\n2  20         0      5  2.934959e-02\n3  20         0      7 2.964394e-323\n4  40         0      3  9.993936e-01\n5  40         0      5  9.976749e-01\n6  40         0      7  6.126327e-01\n```\n\n\n:::\n:::\n\n\n\nThe estimated survival probabilities go down over time. For example a\n20-year-old woman here has estimated probability 0.0293 of still dancing\nafter 5 months.\n\n## A graph\n\nWe can plot the predictions over time for an experimental condition such\nas age. The key for `plot_predictions` is to put time *first* in the\n`condition`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(dance.1, condition = c(\"Months\", \"Age\"), \n                 type = \"survival\") +\n     coord_cartesian(ylim = c(0, 1)) # y-axis from 0 to 1\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/unnamed-chunk-5-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n\n## Comments\n\n-   The plot picks some representative ages.\n-   It is (usually) best to be up and to the right (has the highest\n    chance of surviving longest).\n-   Hence the oldest women have the best chance to still be dancing\n    longest (the youngest women are most likely to quit soonest).\n\n## The effect of treatment\n\nThe same procedure will get predictions for women who did or did not go\nto the dance competition, at various times:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnew <- datagrid(model = dance.1, Treatment = c(0, 1), Months = c(3, 5, 7))\nnew\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  Quit  Age Treatment Months rowid\n1    1 31.5         0      3     1\n2    1 31.5         0      5     2\n3    1 31.5         0      7     3\n4    1 31.5         1      3     4\n5    1 31.5         1      5     5\n6    1 31.5         1      7     6\n```\n\n\n:::\n:::\n\n\n\nThe age used for predictions is the mean of all ages.\n\n## The predictions\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncbind(predictions(dance.1, newdata = new, type = \"survival\")) %>% \n  select(Age, Treatment, Months, estimate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Age Treatment Months     estimate\n1 31.5         0      3 9.864573e-01\n2 31.5         0      5 9.490195e-01\n3 31.5         0      7 1.646297e-05\n4 31.5         1      3 9.998406e-01\n5 31.5         1      5 9.993886e-01\n6 31.5         1      7 8.792014e-01\n```\n\n\n:::\n:::\n\n\n\nWomen of this age have a high (0.879) chance of still dancing after 7\nmonths if they went to the dance competition, but much lower (almost zero) if\nthey did not.\n\n## A graph\n\nAgain, time first, effect of interest second (as colours):\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(dance.1, \n                 condition = c(\"Months\", \"Treatment\"), \n                 type = \"survival\") + \n  coord_cartesian(ylim = c(0, 1)) -> g\n```\n:::\n\n\n\n## The graph\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/unnamed-chunk-9-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n\n## Comments\n\n-   The survival curve for Treatment 1 is higher all the way along\n-   Hence at any time, the women who went to the dance competition have\n    a higher chance of still dancing than those who did not.\n\n## The model summary again\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(dance.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(Months, Quit) ~ Treatment + Age, data = dance)\n\n  n= 12, number of events= 10 \n\n              coef exp(coef) se(coef)      z Pr(>|z|)  \nTreatment -4.44915   0.01169  2.60929 -1.705   0.0882 .\nAge       -0.36619   0.69337  0.15381 -2.381   0.0173 *\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n          exp(coef) exp(-coef) lower .95 upper .95\nTreatment   0.01169     85.554 7.026e-05    1.9444\nAge         0.69337      1.442 5.129e-01    0.9373\n\nConcordance= 0.964  (se = 0.039 )\nLikelihood ratio test= 21.68  on 2 df,   p=2e-05\nWald test            = 5.67  on 2 df,   p=0.06\nScore (logrank) test = 14.75  on 2 df,   p=6e-04\n```\n\n\n:::\n:::\n\n\n\n## Comments\n\n-   The numbers in the `coef` column describe effect of that variable on\n    log-hazard of quitting.\n-   Both numbers are negative, so a higher value on both variables goes\n    with a lower hazard of quitting:\n    -   an older woman is less likely to quit soon (more likely to be\n        still dancing)\n    -   a woman who went to the dance competition (`Treatment = 1`) is\n        less likely to quit soon vs. a woman who didn't (more likely to\n        be still dancing).\n\n## Model checking\n\n-   With regression, usually plot residuals against fitted values.\n\n-   Not quite same here (nonlinear model), but \"martingale residuals\"\n    should have no pattern vs. \"linear predictor\".\n\n-   Use `broom` ideas to get them, in `.resid` and `.fitted` as below.\n\n-   Martingale residuals can go very negative, so won't always look\n    normal.\n\n## Martingale residuals\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndance.1 %>% augment(dance) %>% \n  ggplot(aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth()\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/unnamed-chunk-11-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## A more realistic example: lung cancer\n\n-   When you load in an R package, get data sets to illustrate functions\n    in the package.\n\n-   One such is `lung`. Data set measuring survival in patients with\n    advanced lung cancer.\n\n-   Along with survival time, number of \"performance scores\" included,\n    measuring how well patients can perform daily activities.\n\n-   Sometimes high good, but sometimes bad!\n\n-   Variables below, from the data set help file (`?lung`).\n\n## The variables\n\n![](lung-cancer-data.png)\n\n## Uh oh, missing values\n\n\\scriptsize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung %>% select(meal.cal, wt.loss)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n    meal.cal wt.loss\n1       1175      NA\n2       1225      15\n3         NA      15\n4       1150      11\n5         NA       0\n6        513       0\n7        384      10\n8        538       1\n9        825      16\n10       271      34\n11      1025      27\n12        NA      23\n13        NA       5\n14      1225      32\n15      2600      60\n16        NA      15\n17      1150      -5\n18      1025      22\n19       238      10\n20      1175      NA\n21      1025      17\n22      1175      -8\n23        NA      16\n24       975      13\n25        NA       0\n26       825       6\n27      1025     -13\n28      1075      20\n29       875      -7\n30       305      20\n31      1025      -1\n32       388      20\n33        NA     -11\n34       925     -15\n35      1075      10\n36      1025      NA\n37       513      28\n38       875       4\n39      1225      24\n40      1175      15\n41       975      10\n42      1075      11\n43       363      27\n44        NA      NA\n45      1025       7\n46       625     -24\n47       463      30\n48      1025      10\n49      1425       2\n50      1175       4\n51        NA       9\n52        NA       0\n53      1025       0\n54      1175       7\n55      1300      15\n56       725      NA\n57       338       5\n58        NA      18\n59      1225      10\n60      1075      -3\n61       438       8\n62      1300      68\n63      1025      NA\n64      1025       0\n65      1125       0\n66       825       8\n67       538       2\n68      1025       3\n69      1039       0\n70       488      23\n71      1175      -1\n72       538      29\n73      1175       0\n74        NA       3\n75       825       3\n76      1075      19\n77      1300       0\n78      1225      -2\n79       731      15\n80       169      30\n81       768       5\n82      1500      15\n83      1425       8\n84       588      -1\n85      1025       1\n86      1100      14\n87      1150       1\n88      1175       4\n89       588      39\n90       910       2\n91       975      -1\n92        NA      23\n93       875       8\n94       280      14\n95        NA      13\n96       288       7\n97        NA      25\n98        NA       0\n99       910       0\n100       NA      10\n101      710      15\n102     1175       3\n103       NA       4\n104       NA       0\n105       NA      32\n106      875      14\n107      975      -3\n108      925      NA\n109      975       5\n110      925      11\n111      575      10\n112     1175       5\n113     1030       6\n114       NA       1\n115       NA      15\n116      413      20\n117      675      20\n118     1300      30\n119      613      24\n120      346      11\n121       NA       0\n122      675      10\n123      910       0\n124      768      -3\n125     1025      17\n126      925      20\n127     1075      13\n128      993       0\n129      750      28\n130       NA       4\n131      925      52\n132       NA      20\n133     1225       5\n134       NA      49\n135      313       6\n136       96      37\n137       NA       0\n138     1075      NA\n139      975      -5\n140     1500      15\n141     1225     -16\n142      413      38\n143     1500       8\n144     1075       0\n145      513      30\n146       NA       2\n147      775       2\n148     1225      13\n149      413      27\n150       NA       0\n151     1175      -2\n152       NA       7\n153       NA       0\n154       NA       4\n155     1025      10\n156      713      20\n157       NA       7\n158      475      27\n159      538      -2\n160      825      17\n161      588       8\n162     2450       2\n163     2450      36\n164      875       2\n165      413      16\n166     1075       3\n167       NA      33\n168      860       4\n169      730       0\n170     1025       0\n171      825       2\n172     1225      10\n173      768      37\n174      338       6\n175     1225      12\n176     1025       0\n177     1225      -2\n178       NA      NA\n179      588      13\n180      588       0\n181      975       5\n182     1225      -5\n183     1025      NA\n184       NA      -1\n185     1225       0\n186      975       5\n187      463      20\n188     1300       8\n189     1025      12\n190     1225       8\n191      488      14\n192     1075      NA\n193      513      NA\n194      825      33\n195     1300      -2\n196     1175       6\n197      825       0\n198       NA       4\n199      975       0\n200     1275       0\n201      488      37\n202     2200       5\n203     1025       0\n204      635       1\n205      413       0\n206       NA      NA\n207       NA      23\n208     1025      -3\n209       NA      NA\n210       NA      10\n211      488      -2\n212      413      23\n213     1075       0\n214       NA      31\n215       NA      10\n216     1025      18\n217       NA     -10\n218      825       7\n219      131       3\n220      725      11\n221     1500       2\n222     1025       0\n223       NA       0\n224       NA       3\n225     2350      -5\n226     1025       5\n227     1075       1\n228     1060       0\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## A closer look\n\n\n\n::: {.cell}\n\n:::\n\n\n\n\\tiny\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      inst            time            status           age       \n Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n 1st Qu.: 3.00   1st Qu.: 166.8   1st Qu.:1.000   1st Qu.:56.00  \n Median :11.00   Median : 255.5   Median :2.000   Median :63.00  \n Mean   :11.09   Mean   : 305.2   Mean   :1.724   Mean   :62.45  \n 3rd Qu.:16.00   3rd Qu.: 396.5   3rd Qu.:2.000   3rd Qu.:69.00  \n Max.   :33.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n NA's   :1                                                       \n      sex           ph.ecog          ph.karno        pat.karno     \n Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n 1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 75.00   1st Qu.: 70.00  \n Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n Mean   :1.395   Mean   :0.9515   Mean   : 81.94   Mean   : 79.96  \n 3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n                 NA's   :1        NA's   :1        NA's   :3       \n    meal.cal         wt.loss       \n Min.   :  96.0   Min.   :-24.000  \n 1st Qu.: 635.0   1st Qu.:  0.000  \n Median : 975.0   Median :  7.000  \n Mean   : 928.8   Mean   :  9.832  \n 3rd Qu.:1150.0   3rd Qu.: 15.750  \n Max.   :2600.0   Max.   : 68.000  \n NA's   :47       NA's   :14       \n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Remove obs with *any* missing values\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung %>% drop_na() -> lung.complete\nlung.complete %>%\n  select(meal.cal:wt.loss) %>%\n  slice(1:10) \n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   meal.cal wt.loss\n2      1225      15\n4      1150      11\n6       513       0\n7       384      10\n8       538       1\n9       825      16\n10      271      34\n11     1025      27\n15     2600      60\n17     1150      -5\n```\n\n\n:::\n:::\n\n\n\n## Check!\n\n\\tiny\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung.complete)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n      inst            time            status           age       \n Min.   : 1.00   Min.   :   5.0   Min.   :1.000   Min.   :39.00  \n 1st Qu.: 3.00   1st Qu.: 174.5   1st Qu.:1.000   1st Qu.:57.00  \n Median :11.00   Median : 268.0   Median :2.000   Median :64.00  \n Mean   :10.71   Mean   : 309.9   Mean   :1.719   Mean   :62.57  \n 3rd Qu.:15.00   3rd Qu.: 419.5   3rd Qu.:2.000   3rd Qu.:70.00  \n Max.   :32.00   Max.   :1022.0   Max.   :2.000   Max.   :82.00  \n      sex           ph.ecog          ph.karno        pat.karno     \n Min.   :1.000   Min.   :0.0000   Min.   : 50.00   Min.   : 30.00  \n 1st Qu.:1.000   1st Qu.:0.0000   1st Qu.: 70.00   1st Qu.: 70.00  \n Median :1.000   Median :1.0000   Median : 80.00   Median : 80.00  \n Mean   :1.383   Mean   :0.9581   Mean   : 82.04   Mean   : 79.58  \n 3rd Qu.:2.000   3rd Qu.:1.0000   3rd Qu.: 90.00   3rd Qu.: 90.00  \n Max.   :2.000   Max.   :3.0000   Max.   :100.00   Max.   :100.00  \n    meal.cal         wt.loss       \n Min.   :  96.0   Min.   :-24.000  \n 1st Qu.: 619.0   1st Qu.:  0.000  \n Median : 975.0   Median :  7.000  \n Mean   : 929.1   Mean   :  9.719  \n 3rd Qu.:1162.5   3rd Qu.: 15.000  \n Max.   :2600.0   Max.   : 68.000  \n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\nNo missing values left.\n\n## Model 1: use everything except `inst`\n\n\\footnotesize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnames(lung.complete)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n [1] \"inst\"      \"time\"      \"status\"    \"age\"       \"sex\"      \n [6] \"ph.ecog\"   \"ph.karno\"  \"pat.karno\" \"meal.cal\"  \"wt.loss\"  \n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n-   Event was death, goes with `status` of 2:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.1 <- coxph(\n  Surv(time, status == 2) ~ . - inst - time - status,\n  data = lung.complete\n)\n```\n:::\n\n\n\n\"Dot\" means \"all the other variables\".\n\n## `summary` of model 1\n\n\\tiny\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, status == 2) ~ . - inst - time - status, \n    data = lung.complete)\n\n  n= 167, number of events= 120 \n\n                coef  exp(coef)   se(coef)      z Pr(>|z|)   \nage        1.080e-02  1.011e+00  1.160e-02  0.931  0.35168   \nsex       -5.536e-01  5.749e-01  2.016e-01 -2.746  0.00603 **\nph.ecog    7.395e-01  2.095e+00  2.250e-01  3.287  0.00101 **\nph.karno   2.244e-02  1.023e+00  1.123e-02  1.998  0.04575 * \npat.karno -1.207e-02  9.880e-01  8.116e-03 -1.488  0.13685   \nmeal.cal   2.835e-05  1.000e+00  2.594e-04  0.109  0.91298   \nwt.loss   -1.420e-02  9.859e-01  7.766e-03 -1.828  0.06748 . \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n          exp(coef) exp(-coef) lower .95 upper .95\nage          1.0109     0.9893    0.9881    1.0341\nsex          0.5749     1.7395    0.3872    0.8534\nph.ecog      2.0950     0.4773    1.3479    3.2560\nph.karno     1.0227     0.9778    1.0004    1.0455\npat.karno    0.9880     1.0121    0.9724    1.0038\nmeal.cal     1.0000     1.0000    0.9995    1.0005\nwt.loss      0.9859     1.0143    0.9710    1.0010\n\nConcordance= 0.653  (se = 0.029 )\nLikelihood ratio test= 28.16  on 7 df,   p=2e-04\nWald test            = 27.5  on 7 df,   p=3e-04\nScore (logrank) test = 28.31  on 7 df,   p=2e-04\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Overall significance\n\nThe three tests of overall significance: \\small\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nglance(lung.1) %>% select(starts_with(\"p.value\"))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 1 x 4\n  p.value.log p.value.sc p.value.wald p.value.robust\n        <dbl>      <dbl>        <dbl>          <dbl>\n1    0.000205   0.000193     0.000271             NA\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\nAll strongly significant. *Something* predicts survival.\n\n## Coefficients for model 1\n\n\\small\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(lung.1) %>% select(term, p.value) %>% arrange(p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 7 x 2\n  term      p.value\n  <chr>       <dbl>\n1 ph.ecog   0.00101\n2 sex       0.00603\n3 ph.karno  0.0457 \n4 wt.loss   0.0675 \n5 pat.karno 0.137  \n6 age       0.352  \n7 meal.cal  0.913  \n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n-   `sex` and `ph.ecog` definitely significant here\n\n-   `age`, `pat.karno` and `meal.cal` definitely not\n\n-   Take out definitely non-sig variables, and try again.\n\n## Model 2\n\n\\small\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.2 <- update(lung.1, . ~ . - age - pat.karno - meal.cal)\nsummary(lung.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, status == 2) ~ sex + ph.ecog + ph.karno + \n    wt.loss, data = lung.complete)\n\n  n= 167, number of events= 120 \n\n              coef exp(coef)  se(coef)      z Pr(>|z|)    \nsex      -0.570881  0.565028  0.198842 -2.871 0.004091 ** \nph.ecog   0.844660  2.327188  0.218644  3.863 0.000112 ***\nph.karno  0.017877  1.018038  0.010887  1.642 0.100584    \nwt.loss  -0.012048  0.988025  0.007495 -1.607 0.107975    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\nsex          0.565     1.7698    0.3827    0.8343\nph.ecog      2.327     0.4297    1.5161    3.5722\nph.karno     1.018     0.9823    0.9965    1.0400\nwt.loss      0.988     1.0121    0.9736    1.0026\n\nConcordance= 0.646  (se = 0.031 )\nLikelihood ratio test= 24.9  on 4 df,   p=5e-05\nWald test            = 24.19  on 4 df,   p=7e-05\nScore (logrank) test = 24.61  on 4 df,   p=6e-05\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Compare with first model:\n\n\\normalsize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(lung.2, lung.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table\n Cox model: response is  Surv(time, status == 2)\n Model 1: ~ sex + ph.ecog + ph.karno + wt.loss\n Model 2: ~ (inst + age + sex + ph.ecog + ph.karno + pat.karno + meal.cal + wt.loss) - inst - time - status\n   loglik Chisq Df Pr(>|Chi|)\n1 -495.67                    \n2 -494.03 3.269  3      0.352\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n-   No harm in taking out those variables.\n\n## Model 3\n\nTake out `ph.karno` and `wt.loss` as well.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.3 <- update(lung.2, . ~ . - ph.karno - wt.loss)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntidy(lung.3) %>% select(term, estimate, p.value)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 2 x 3\n  term    estimate  p.value\n  <chr>      <dbl>    <dbl>\n1 sex       -0.510 0.00958 \n2 ph.ecog    0.483 0.000266\n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(lung.3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, status == 2) ~ sex + ph.ecog, data = lung.complete)\n\n  n= 167, number of events= 120 \n\n           coef exp(coef) se(coef)      z Pr(>|z|)    \nsex     -0.5101    0.6004   0.1969 -2.591 0.009579 ** \nph.ecog  0.4825    1.6201   0.1323  3.647 0.000266 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n        exp(coef) exp(-coef) lower .95 upper .95\nsex        0.6004     1.6655    0.4082    0.8832\nph.ecog    1.6201     0.6172    1.2501    2.0998\n\nConcordance= 0.641  (se = 0.031 )\nLikelihood ratio test= 19.48  on 2 df,   p=6e-05\nWald test            = 19.35  on 2 df,   p=6e-05\nScore (logrank) test = 19.62  on 2 df,   p=5e-05\n```\n\n\n:::\n:::\n\n\n\n## Check whether that was OK\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nanova(lung.3, lung.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table\n Cox model: response is  Surv(time, status == 2)\n Model 1: ~ sex + ph.ecog\n Model 2: ~ sex + ph.ecog + ph.karno + wt.loss\n   loglik  Chisq Df Pr(>|Chi|)  \n1 -498.38                       \n2 -495.67 5.4135  2    0.06675 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n\n\n*Just* OK.\n\n## Commentary\n\n-   OK (just) to take out those two covariates.\n\n-   Both remaining variables strongly significant.\n\n-   Nature of effect on survival time? Consider later.\n\n-   Picture?\n\n## Plotting survival probabilities\n\n-   Assess (separately) the effect of `sex` and `ph.ecog` score using\n    `plot_predictions`\n-   Don't forget to add time (here actually called `time`) to the\n    `condition`.\n\n## Effect of `sex`:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(lung.3, condition = c(\"time\", \"sex\"), \n                 type = \"survival\")\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/unnamed-chunk-12-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n-   Females (`sex = 2`) have better survival than males.\n-   This graph from a mean `ph.ecog` score, but the male-female\n    comparison is the same for any score.\n\n## Effect of `ph.ecog` score:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(lung.3, condition = c(\"time\", \"ph.ecog\"), \n                 type = \"survival\")\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/unnamed-chunk-13-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Comments\n\n-   A lower `ph.ecog` score is better.\n-   For example, a patient with a score of 0 has almost a 50-50 chance\n    of living 500 days, but a patient with a score of 3 has almost no\n    chance to survive that long.\n-   Is this for males or females? See over. (The comparison of scores is\n    the same for both.) How many males and females did we observe?\n    \n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung %>% count(sex)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  sex   n\n1   1 138\n2   2  90\n```\n\n\n:::\n:::\n\n\n    \n\n## Sex and `ph.ecog` score\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nplot_predictions(lung.3, condition = c(\"time\", \"ph.ecog\", \"sex\"), type = \"survival\")\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/unnamed-chunk-15-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Comments\n\n-   The previous graph was males. There were more males in the dataset (`sex` of 1).\n-   This pair of graphs shows the effect of `ph.ecog` score (above and\n    below on each facet), and the effect of males (left) vs. females\n    (right).\n-   The difference between males and females is about the same as 1\n    point on the `ph.ecog` scale (compare the red curve on the left\n    facet with the green curve on the right facet).\n\n## The summary again\n\n\\small\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(lung.3)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = Surv(time, status == 2) ~ sex + ph.ecog, data = lung.complete)\n\n  n= 167, number of events= 120 \n\n           coef exp(coef) se(coef)      z Pr(>|z|)    \nsex     -0.5101    0.6004   0.1969 -2.591 0.009579 ** \nph.ecog  0.4825    1.6201   0.1323  3.647 0.000266 ***\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n        exp(coef) exp(-coef) lower .95 upper .95\nsex        0.6004     1.6655    0.4082    0.8832\nph.ecog    1.6201     0.6172    1.2501    2.0998\n\nConcordance= 0.641  (se = 0.031 )\nLikelihood ratio test= 19.48  on 2 df,   p=6e-05\nWald test            = 19.35  on 2 df,   p=6e-05\nScore (logrank) test = 19.62  on 2 df,   p=5e-05\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Comments\n\n-   A higher-numbered sex (female) has a lower hazard of death (negative\n    coef). That is, females are more likely to survive longer than\n    males.\n-   A higher `ph.ecog` score goes with a *higher* hazard of death\n    (positive coef). So patients with a *lower* score are more likely to\n    survive longer.\n-   These are consistent with the graphs we drew.\n\n## Martingale residuals for this model\n\nNo problems here:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlung.3 %>% augment(lung.complete) %>% \n  ggplot(aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth()\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-32-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## When the Cox model fails (optional)\n\n-   Invent some data where survival is best at middling age, and worse\n    at high *and* low age:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nage <- seq(20, 60, 5)\nsurvtime <- c(10, 12, 11, 21, 15, 20, 8, 9, 11)\nstat <- c(1, 1, 1, 1, 0, 1, 1, 1, 1)\nd <- tibble(age, survtime, stat)\nd %>% mutate(y = Surv(survtime, stat)) -> d\nd\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 9 x 4\n    age survtime  stat      y\n  <dbl>    <dbl> <dbl> <Surv>\n1    20       10     1    10 \n2    25       12     1    12 \n3    30       11     1    11 \n4    35       21     1    21 \n5    40       15     0    15+\n6    45       20     1    20 \n7    50        8     1     8 \n8    55        9     1     9 \n9    60       11     1    11 \n```\n\n\n:::\n:::\n\n\n\n-   Small survival time 15 in middle was actually censored, so would\n    have been longer if observed.\n\n## Fit Cox model\n\n\\footnotesize\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny.1 <- coxph(y ~ age, data = d)\nsummary(y.1)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = y ~ age, data = d)\n\n  n= 9, number of events= 8 \n\n       coef exp(coef) se(coef)     z Pr(>|z|)\nage 0.01984   1.02003  0.03446 0.576    0.565\n\n    exp(coef) exp(-coef) lower .95 upper .95\nage      1.02     0.9804    0.9534     1.091\n\nConcordance= 0.545  (se = 0.105 )\nLikelihood ratio test= 0.33  on 1 df,   p=0.6\nWald test            = 0.33  on 1 df,   p=0.6\nScore (logrank) test = 0.33  on 1 df,   p=0.6\n```\n\n\n:::\n:::\n\n\n\n\\normalsize\n\n## Martingale residuals\n\nDown-and-up indicates incorrect relationship between age and survival:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny.1 %>% augment(d) %>% \n  ggplot(aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth()\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-35-1.pdf){fig-pos='H'}\n:::\n:::\n\n\n\n## Attempt 2\n\nAdd squared term in age:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny.2 <- coxph(y ~ age + I(age^2), data = d)\nsummary(y.2)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nCall:\ncoxph(formula = y ~ age + I(age^2), data = d)\n\n  n= 9, number of events= 8 \n\n              coef exp(coef)  se(coef)      z Pr(>|z|)  \nage      -0.380184  0.683736  0.241617 -1.573   0.1156  \nI(age^2)  0.004832  1.004844  0.002918  1.656   0.0977 .\n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n         exp(coef) exp(-coef) lower .95 upper .95\nage         0.6837     1.4626    0.4258     1.098\nI(age^2)    1.0048     0.9952    0.9991     1.011\n\nConcordance= 0.758  (se = 0.123 )\nLikelihood ratio test= 3.26  on 2 df,   p=0.2\nWald test            = 3.16  on 2 df,   p=0.2\nScore (logrank) test = 3.75  on 2 df,   p=0.2\n```\n\n\n:::\n:::\n\n\n\n-   (Marginally) helpful.\n\n## Martingale residuals this time\n\nNot great, but less problematic than before:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ny.2 %>% augment(d) %>% \n  ggplot(aes(x = .fitted, y = .resid)) + geom_point() + geom_smooth()\n```\n\n::: {.cell-output-display}\n![](survival_files/figure-beamer/bSurvival-37-1.pdf){fig-pos='H'}\n:::\n:::\n",
    "supporting": [
      "survival_files/figure-beamer"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": null,
    "postProcess": false
  }
}